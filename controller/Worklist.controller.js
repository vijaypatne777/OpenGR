sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Token","sap/m/Label","sap/m/MessageToast","sap/ui/export/Spreadsheet"],function(e,t,r,i,s,n,a,u,o){"use strict";return e.extend("OpenGR.OpenGR.controller.Worklist",{formatter:r,onInit:function(){this._dModel=this.getOwnerComponent().getModel();this._sModel=this.getOwnerComponent().getModel("smodel");this._xModel=new sap.ui.model.json.JSONModel;this._poRec=[];this._grRec=[];this._rgrRec=[];this._invRec=[];this._rinvRec=[];this._poout=[];this._xRec=[];this._xOut={rec:this._xRec};this._out={rec:this._poout,gramount:this._tgramount,grcurrency:this._grcurrency,invamount:this._tinvamount,invcurrency:this._invcurrency};this._oModel=new sap.ui.model.json.JSONModel;var e=function(e){var t=e.text;return new n({text:t,key:t})};var t=function(e){var t=e.text;return new n({text:t,key:t})};var r=function(e){var t=e.text;return new n({text:t,key:t})};var i=this.byId("purord");i.addValidator(t);var s=this.byId("purgrp");s.addValidator(e);var a=this.byId("supp");a.addValidator(r)},onUpdateFinished:function(e){},onPress:function(e){},onShareInJamPress:function(){},onSearch:function(e){},onRefresh:function(){},_showObject:function(e){},_applySearch:function(e){},_getPOHistoryData:function(){this._poRec=[];this._grRec=[];this._rgrRec=[];this._invRec=[];this._rinvRec=[];this._poout=[];this._tgramount=0;this._tinvamount=0;this._grcurrency="";this._invcurrency="";this._oModel.setData();var e=[];var t=this.byId("purord");var r=this.byId("kdate");var n=t.getTokens();var a=this.byId("purgrp");var u=a.getTokens();var o=this.byId("supp");var c=o.getTokens();var h=r.getValue();var l="X";if(h===""){l=" ";sap.m.MessageBox.warning("Please enter the key date")}if(n.length===0&&u.length===0&&c.length===0){l=" ";var p=this.getView().getModel("i18n").getResourceBundle().getText("emsg");sap.m.MessageBox.warning(p)}if(l==="X"){sap.ui.core.BusyIndicator.show(1);var g=this;var d=this._dModel;for(var m=0;m<n.length;m++){var y=n[m].getKey();var v=new i("PurchaseOrder",s.EQ,y);e.push(v)}for(var _=0;_<u.length;_++){var P=u[_].getKey();var R=new i("PurchasingOrganization",s.EQ,P);e.push(R)}for(var O=0;O<c.length;O++){var f=c[O].getKey();var w=new i("Supplier",s.EQ,f);e.push(w)}var I;I=h;var x=new i("PostingDate",s.LE,I);e.push(x);var M=new Promise(function(t,r){d.read("/YY1_Open_GR_Details",{filters:e,success:function(e){for(var r=0;r<e.results.length;r++){var i={};var s={};var n={};var a={};var u={};if(e.results[r].GoodsMovementType==="101"&&e.results[r].PurchasingHistoryCategory==="E"&&e.results[r].PurchasingHistoryDocumentType==="1"){i.PurchaseOrder=e.results[r].PurchaseOrder;i.PurchaseOrderItem=e.results[r].PurchaseOrderItem;i.Supplier=e.results[r].Supplier;i.SupplierName=e.results[r].SupplierName;i.Material=e.results[r].Material;i.ProductName=e.results[r].ProductName;i.ddate=e.results[r].PostingDate;i.pdate=e.results[r].PostingDate;i.MaterialBaseUnit=e.results[r].MaterialBaseUnit;i.Plant=e.results[r].Plant;i.OrderQuantity=e.results[r].OrderQuantity;i.PurchaseOrderQuantityUnit=e.results[r].PurchaseOrderQuantityUnit;i.NetAmount=e.results[r].NetAmount;i.NetPriceAmount=e.results[r].NetPriceAmount;i.pocurrency=e.results[r].DocumentCurrency;if(!(g._poRec.filter(function(e){return e.PurchaseOrder===i.PurchaseOrder&&e.PurchaseOrderItem===i.PurchaseOrderItem}).length>0)){g._poRec.push(i)}}if(e.results[r].GoodsMovementType==="101"&&e.results[r].PurchasingHistoryCategory==="E"&&e.results[r].PurchasingHistoryDocumentType==="1"){s.PurchaseOrder=e.results[r].PurchaseOrder;s.PurchaseOrderItem=e.results[r].PurchaseOrderItem;s.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;s.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;s.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;s.grquantity=e.results[r].Quantity;s.GRAmount=e.results[r].GRAmount;s.grcurrency=e.results[r].DocumentCurrency_01;var o=g._grRec.findIndex(function(e){return e.PurchaseOrder===s.PurchaseOrder&&e.PurchaseOrderItem===s.PurchaseOrderItem});if(o===-1){g._grRec.push(s)}else{g._grRec[o].grquantity=parseFloat(g._grRec[o].grquantity)+parseFloat(s.grquantity);g._grRec[o].GRAmount=parseFloat(g._grRec[o].GRAmount)+parseFloat(s.GRAmount)}}if(e.results[r].GoodsMovementType==="102"&&e.results[r].PurchasingHistoryCategory==="E"&&e.results[r].PurchasingHistoryDocumentType==="1"){n.PurchaseOrder=e.results[r].PurchaseOrder;n.PurchaseOrderItem=e.results[r].PurchaseOrderItem;n.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;n.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;n.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;n.rgrquantity=e.results[r].Quantity;n.rGRAmount=e.results[r].GRAmount;n.grcurrency=e.results[r].DocumentCurrency_01;var c=g._rgrRec.findIndex(function(e){return e.PurchaseOrder===n.PurchaseOrder&&e.PurchaseOrderItem===n.PurchaseOrderItem});if(c===-1){n.rgrquantity=parseFloat(n.rgrquantity)*-1;n.rGRAmount=parseFloat(n.rGRAmount)*-1;g._rgrRec.push(n)}else{g._rgrRec[c].rgrquantity=parseFloat(g._rgrRec[c].rgrquantity)+parseFloat(n.rgrquantity)*-1;g._rgrRec[c].rGRAmount=parseFloat(g._rgrRec[c].rGRAmount)+parseFloat(n.rGRAmount)*-1}}if(e.results[r].DebitCreditCode==="S"&&e.results[r].PurchasingHistoryCategory==="Q"&&e.results[r].PurchasingHistoryDocumentType==="2"){a.PurchaseOrder=e.results[r].PurchaseOrder;a.PurchaseOrderItem=e.results[r].PurchaseOrderItem;a.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;a.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;a.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;a.invquantity=e.results[r].Quantity;a.invamount=e.results[r].InvoiceAmtInCoCodeCrcy;a.invcurrency=e.results[r].DocumentCurrency_01;var h=g._invRec.findIndex(function(e){return e.PurchaseOrder===a.PurchaseOrder&&e.PurchaseOrderItem===a.PurchaseOrderItem});if(h===-1){g._invRec.push(a)}else{g._invRec[h].invquantity=parseFloat(g._invRec[h].invquantity)+parseFloat(a.invquantity);g._invRec[h].invamount=parseFloat(g._invRec[h].invamount)+parseFloat(a.invamount)}}if(e.results[r].DebitCreditCode==="H"&&e.results[r].PurchasingHistoryCategory==="Q"&&e.results[r].PurchasingHistoryDocumentType==="2"){u.PurchaseOrder=e.results[r].PurchaseOrder;u.PurchaseOrderItem=e.results[r].PurchaseOrderItem;u.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;u.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;u.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;u.rinvquantity=e.results[r].Quantity;u.rinvamount=e.results[r].InvoiceAmtInCoCodeCrcy;u.rinvcurrency=e.results[r].DocumentCurrency_01;var l=g._rinvRec.findIndex(function(e){return e.PurchaseOrder===u.PurchaseOrder&&e.PurchaseOrderItem===u.PurchaseOrderItem});if(l===-1){u.rinvquantity=parseFloat(u.rinvquantity)*-1;u.rinvamount=parseFloat(u.rinvamount)*-1;g._rinvRec.push(u)}else{g._rinvRec[l].rinvquantity=parseFloat(g._rinvRec[l].rinvquantity)+parseFloat(u.rinvquantity)*-1;g._rinvRec[l].rinvamount=parseFloat(g._rinvRec[l].rinvamount)+parseFloat(u.rinvamount)*-1}}}t()},error:function(e){var t={};r()}})});M.then(function(){g._calculateOpenGR()})}},getData:function(e){this._getPOHistoryData()},_calculateOpenGR:function(){for(var e=0;e<this._poRec.length;e++){var t={};t.PurchaseOrder=this._poRec[e].PurchaseOrder;t.PurchaseOrderItem=this._poRec[e].PurchaseOrderItem;t.Supplier=this._poRec[e].Supplier;t.SupplierName=this._poRec[e].SupplierName;t.Material=this._poRec[e].Material;t.ProductName=this._poRec[e].ProductName;t.ddate=this._poRec[e].ddate;t.pdate=this._poRec[e].pdate;t.MaterialBaseUnit=this._poRec[e].MaterialBaseUnit;t.Plant=this._poRec[e].Plant;t.OrderQuantity=this._poRec[e].OrderQuantity;t.PurchaseOrderQuantityUnit=this._poRec[e].PurchaseOrderQuantityUnit;t.NetAmount=this._poRec[e].NetAmount;t.NetPriceAmount=this._poRec[e].NetPriceAmount;t.pocurrency=this._poRec[e].pocurrency;t.DocumentCurrency=this._poRec[e].DocumentCurrency;for(var r=0;r<this._grRec.length;r++){if(t.PurchaseOrder===this._grRec[r].PurchaseOrder&&t.PurchaseOrderItem===this._grRec[r].PurchaseOrderItem){t.grquantity=this._grRec[r].grquantity;t.gramount=this._grRec[r].GRAmount;t.grcurrency=this._grRec[r].grcurrency;t.grunitprice=t.NetPriceAmount;this._grcurrency=t.grcurrency}}for(var i=0;i<this._rgrRec.length;i++){if(t.PurchaseOrder===this._rgrRec[i].PurchaseOrder&&t.PurchaseOrderItem===this._rgrRec[i].PurchaseOrderItem){t.rgrquantity=this._rgrRec[i].rgrquantity;t.rgramount=this._rgrRec[i].rGRAmount}}for(var s=0;s<this._invRec.length;s++){if(t.PurchaseOrder===this._invRec[s].PurchaseOrder&&t.PurchaseOrderItem===this._invRec[s].PurchaseOrderItem){t.invquantity=this._invRec[s].invquantity;t.invamount=this._invRec[s].invamount;t.invcurrency=this._invRec[s].invcurrency;this._invcurrency=t.invcurrency;t.invunitprice=t.NetPriceAmount}}for(var n=0;n<this._rinvRec.length;n++){if(t.PurchaseOrder===this._rinvRec[n].PurchaseOrder&&t.PurchaseOrderItem===this._rinvRec[n].PurchaseOrderItem){t.rinvquantity=this._rinvRec[n].rinvquantity;t.rinvamount=this._rinvRec[n].rinvamount}}if(isNaN(t.rgrquantity)){t.rgrquantity=0}if(isNaN(t.rgramount)){t.rgramount=0}if(isNaN(t.invquantity)){t.invquantity=0}if(isNaN(t.invamount)){t.invamount=0}if(isNaN(t.rinvquantity)){t.rinvquantity=0}if(isNaN(t.rinvamount)){t.rinvamount=0}t.tgrquantity=parseFloat(t.grquantity)+parseFloat(t.rgrquantity);t.tinvquantity=parseFloat(t.invquantity)+parseFloat(t.rinvquantity);t.tgramount=parseFloat(t.gramount)+parseFloat(t.rgramount);t.tinvamount=parseFloat(t.invamount)+parseFloat(t.rinvamount);t.damount=parseFloat(t.tgramount)-parseFloat(t.tinvamount);t.qdiff=parseFloat(t.tgrquantity)-parseFloat(t.tinvquantity);t.tgramount=parseFloat(t.tgramount).toFixed(2);t.tinvamount=parseFloat(t.tinvamount).toFixed(2);t.damount=parseFloat(t.damount).toFixed(2);this._tgramount=parseFloat(this._tgramount)+parseFloat(t.tgramount);this._tinvamount=parseFloat(this._tinvamount)+parseFloat(t.tinvamount);if(t.qdiff!==0){this._poout.push(t)}this._poout.sort(function(e,t){var r=parseInt(e.PurchaseOrder);var i=parseInt(e.PurchaseOrderItem);var s=parseInt(t.PurchaseOrder);var n=parseInt(t.PurchaseOrderItem);if(r<s){return-1}if(r===s){if(i<n){return-1}}});this._tgramount=parseFloat(this._tgramount).toFixed(2);this._tinvamount=parseFloat(this._tinvamount).toFixed(2)}this._display()},_display:function(){sap.ui.core.BusyIndicator.hide();var e=this.byId("openGRTable");this._out.rec=this._poout;this._out.gramount=this._tgramount;this._out.grcurrency=this._grcurrency;this._out.invamount=this._tinvamount;this._out.invcurrency=this._invcurrency;this._oModel.setData(this._out);e.setModel(this._oModel)},searchSuppliers:function(){var e=sap.ui.core.Fragment.load({name:"OpenGR.OpenGR.view.supplierHelp",controller:this});var t=this;e.then(function(e){t._helpDialog=e;e.open();e.getTableAsync().then(function(r){var i=new a({text:"{Supplier}"});var s=new sap.ui.table.Column({label:"Supplier",template:i,width:"8rem"});var n=new a({text:"{SupplierName}"});var u=new sap.ui.table.Column({label:"SupplierName",template:n,width:"8rem"});r.addColumn(s);r.addColumn(u);r.setModel(t._sModel);r.bindAggregation("rows",{path:"/A_Supplier",parameters:{select:"Supplier,SupplierName"}});e.update()}).bind(t)})},onValueHelpCancel:function(){this._helpDialog.close()},onValueHelpOk:function(e){var t=e.getParameter("tokens");var r=this.byId("supp");r.setTokens(t);this._helpDialog.close()},onValueHelpAfterClose:function(){this._helpDialog.destroy()},downloadData:function(){if(this._poout.length>0){var e;var t=this._getColumnsData();var r={};r.tgramount=this._tgramount;r.tinvamount=this._tinvamount;r.supplier="Total";this._xRec=this._poout;this._xRec.push(r);this._xOut.rec=this._xRec;this._xModel.setData(this._xOut);var i=this._xModel.getProperty("/rec");e={workbook:{columns:t},dataSource:i};var s=new o(e);s.build().then(function(){u.show("Spreadsheet export has finished")}).finally(s.destroy)}else{var n=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(n)}},_getColumnsData:function(){var e=[];var t=this.getView().getModel("i18n").getResourceBundle().getText("supplier");var r=this.getView().getModel("i18n").getResourceBundle().getText("sname");var i=this.getView().getModel("i18n").getResourceBundle().getText("plant");var s=this.getView().getModel("i18n").getResourceBundle().getText("po");var n=this.getView().getModel("i18n").getResourceBundle().getText("poitem");var a=this.getView().getModel("i18n").getResourceBundle().getText("material");var u=this.getView().getModel("i18n").getResourceBundle().getText("pdesc");var o=this.getView().getModel("i18n").getResourceBundle().getText("invp");var c=this.getView().getModel("i18n").getResourceBundle().getText("dater");var h=this.getView().getModel("i18n").getResourceBundle().getText("poq");var l=this.getView().getModel("i18n").getResourceBundle().getText("pup");var p=this.getView().getModel("i18n").getResourceBundle().getText("pamt");var g=this.getView().getModel("i18n").getResourceBundle().getText("poc");var d=this.getView().getModel("i18n").getResourceBundle().getText("qr");var m=this.getView().getModel("i18n").getResourceBundle().getText("grup");var y=this.getView().getModel("i18n").getResourceBundle().getText("ar");var v=this.getView().getModel("i18n").getResourceBundle().getText("grcurrency");var _=this.getView().getModel("i18n").getResourceBundle().getText("qi");var P=this.getView().getModel("i18n").getResourceBundle().getText("iup");var R=this.getView().getModel("i18n").getResourceBundle().getText("invcurrency");var O=this.getView().getModel("i18n").getResourceBundle().getText("ainv");var f=this.getView().getModel("i18n").getResourceBundle().getText("qd");var w=this.getView().getModel("i18n").getResourceBundle().getText("ad");e.push({label:t,property:"Supplier",width:10,type:"string"});e.push({label:r,property:"SupplierName",width:10,type:"string"});e.push({label:i,property:"Plant",width:10,type:"string"});e.push({label:s,property:"PurchaseOrder",width:10,type:"string"});e.push({label:n,property:"PurchaseOrderItem",width:10,type:"string"});e.push({label:a,property:"Material",width:10,type:"string"});e.push({label:u,property:"ProductName",width:10,type:"string"});e.push({label:o,property:"pdate",width:10,type:"string"});e.push({label:c,property:"ddate",width:10,type:"string"});e.push({label:h,property:"OrderQuantity",width:10,type:"string"});e.push({label:l,property:"NetPriceAmount",width:10,type:"string"});e.push({label:p,property:"NetAmount",width:10,type:"string"});e.push({label:g,property:"pocurrency",width:10,type:"string"});e.push({label:d,property:"tgrquantity",width:10,type:"string"});e.push({label:m,property:"grunitprice",width:10,type:"string"});e.push({label:y,property:"tgramount",width:10,type:"string"});e.push({label:v,property:"grcurrency",width:10,type:"string"});e.push({label:_,property:"tinvquantity",width:10,type:"string"});e.push({label:P,property:"invunitprice",width:10,type:"string"});e.push({label:O,property:"tinvamount",width:10,type:"string"});e.push({label:f,property:"qdiff",width:10,type:"string"});e.push({label:w,property:"damount",width:10,type:"string"});e.push({label:R,property:"invcurrency",width:10,type:"string"});return e}})});