sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Token","sap/m/Label","sap/m/MessageToast","sap/ui/export/Spreadsheet","sap/ui/comp/filterbar/FilterBar","sap/ui/comp/filterbar/FilterGroupItem"],function(e,t,r,s,i,a,n,u,o,l,c){"use strict";return e.extend("OpenGR.OpenGR.controller.Worklist",{formatter:r,onInit:function(){this._ddata="";this._dModel=this.getOwnerComponent().getModel();this._sModel=this.getOwnerComponent().getModel("smodel");this._sarr=[];this._sObj={rec:this._sarr};this._xModel=new sap.ui.model.json.JSONModel;this._cModel=new sap.ui.model.json.JSONModel;this._coModel=this.getOwnerComponent().getModel("cmodel");this._poRec=[];this._grRec=[];this._rgrRec=[];this._invRec=[];this._rinvRec=[];this._poout=[];this._xRec=[];this._xOut={rec:this._xRec};this._out={rec:this._poout,gramount:this._tgramount,grcurrency:this._grcurrency,invamount:this._tinvamount,invcurrency:this._invcurrency,amtdiff:this._tamtdiff,Total:this._total};this._oModel=new sap.ui.model.json.JSONModel;var e=function(e){var t=e.text;return new a({text:t,key:t})};var t=function(e){var t=e.text;return new a({text:t,key:t})};var r=function(e){var t=e.text;return new a({text:t,key:t})};var s=this.byId("purord");s.addValidator(t);var i=this.byId("purgrp");i.addValidator(e);var n=this.byId("supp");n.addValidator(r)},onUpdateFinished:function(e){},onPress:function(e){},onShareInJamPress:function(){},onSearch:function(e){},onRefresh:function(){},_showObject:function(e){},_applySearch:function(e){},_getPOHistoryData:function(){this._poRec=[];this._grRec=[];this._rgrRec=[];this._invRec=[];this._rinvRec=[];this._poout=[];this._tgramount=0;this._tinvamount=0;this._tamtdiff=0;this._grcurrency="";this._invcurrency="";this._oModel.setData();var e=[];var t=this.byId("purord");var r=this.byId("kdate");var a=t.getTokens();var n=this.byId("purgrp");var u=n.getTokens();var o=this.byId("supp");var l=o.getTokens();var c=r.getValue();var h="X";if(c===""){h=" ";sap.m.MessageBox.warning("Please enter the key date")}if(a.length===0&&u.length===0&&l.length===0){h=" ";var p=this.getView().getModel("i18n").getResourceBundle().getText("emsg");sap.m.MessageBox.warning(p)}if(h==="X"){sap.ui.core.BusyIndicator.show(1);var d=this;var g=this._dModel;for(var m=0;m<a.length;m++){var y=a[m].getKey();var v=new s("PurchaseOrder",i.EQ,y);e.push(v)}for(var _=0;_<u.length;_++){var f=u[_].getKey();var P=new s("PurchasingOrganization",i.EQ,f);e.push(P)}for(var R=0;R<l.length;R++){var O=l[R].getKey();var w=new s("Supplier",i.EQ,O);e.push(w)}var M;M=c;var b=new s("PostingDate",i.LE,M);e.push(b);var C=new Promise(function(t,r){g.read("/YY1_Open_GR_Details_API",{filters:e,success:function(e){if(e.results.length>0){for(var r=0;r<e.results.length;r++){var s={};var i={};var a={};var n={};var u={};if(e.results[r].GoodsMovementType==="101"&&e.results[r].PurchasingHistoryCategory==="E"&&e.results[r].PurchasingHistoryDocumentType==="1"){s.PurchaseOrder=e.results[r].PurchaseOrder;s.PurchaseOrderItem=e.results[r].PurchaseOrderItem;s.Supplier=e.results[r].Supplier_01;s.SupplierName=e.results[r].SupplierName_01;s.Material=e.results[r].Material;s.ProductName=e.results[r].ProductName;s.ddate=e.results[r].PostingDate;s.pdate=e.results[r].PostingDate;s.MaterialBaseUnit=e.results[r].MaterialBaseUnit;s.Plant=e.results[r].Plant_01;s.OrderQuantity=e.results[r].OrderQuantity;s.PurchaseOrderQuantityUnit=e.results[r].PurchaseOrderQuantityUnit;s.NetAmount=e.results[r].NetAmount;s.NetPriceAmount=e.results[r].NetPriceAmount;s.pocurrency=e.results[r].DocumentCurrency;if(!(d._poRec.filter(function(e){return e.PurchaseOrder===s.PurchaseOrder&&e.PurchaseOrderItem===s.PurchaseOrderItem}).length>0)){d._poRec.push(s)}}if(e.results[r].GoodsMovementType==="101"&&e.results[r].PurchasingHistoryCategory==="E"&&e.results[r].PurchasingHistoryDocumentType==="1"){i.PurchaseOrder=e.results[r].PurchaseOrder;i.PurchaseOrderItem=e.results[r].PurchaseOrderItem;i.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;i.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;i.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;i.grquantity=e.results[r].Quantity;i.grquantityunit=e.results[r].BaseUnit;i.GRAmount=e.results[r].GRAmount;i.grcurrency=e.results[r].DocumentCurrency_01;var o=d._grRec.findIndex(function(e){return e.PurchaseOrder===i.PurchaseOrder&&e.PurchaseOrderItem===i.PurchaseOrderItem});if(o===-1){d._grRec.push(i)}else{d._grRec[o].grquantity=parseFloat(d._grRec[o].grquantity)+parseFloat(i.grquantity);d._grRec[o].GRAmount=parseFloat(d._grRec[o].GRAmount)+parseFloat(i.GRAmount)}}if(e.results[r].GoodsMovementType==="102"&&e.results[r].PurchasingHistoryCategory==="E"&&e.results[r].PurchasingHistoryDocumentType==="1"){a.PurchaseOrder=e.results[r].PurchaseOrder;a.PurchaseOrderItem=e.results[r].PurchaseOrderItem;a.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;a.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;a.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;a.rgrquantity=e.results[r].Quantity;a.rGRAmount=e.results[r].GRAmount;a.grcurrency=e.results[r].DocumentCurrency_01;var l=d._rgrRec.findIndex(function(e){return e.PurchaseOrder===a.PurchaseOrder&&e.PurchaseOrderItem===a.PurchaseOrderItem});if(l===-1){a.rgrquantity=parseFloat(a.rgrquantity)*-1;a.rGRAmount=parseFloat(a.rGRAmount)*-1;d._rgrRec.push(a)}else{d._rgrRec[l].rgrquantity=parseFloat(d._rgrRec[l].rgrquantity)+parseFloat(a.rgrquantity)*-1;d._rgrRec[l].rGRAmount=parseFloat(d._rgrRec[l].rGRAmount)+parseFloat(a.rGRAmount)*-1}}if(e.results[r].DebitCreditCode==="S"&&e.results[r].PurchasingHistoryCategory==="Q"&&e.results[r].PurchasingHistoryDocumentType==="2"){n.PurchaseOrder=e.results[r].PurchaseOrder;n.PurchaseOrderItem=e.results[r].PurchaseOrderItem;n.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;n.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;n.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;n.invquantity=e.results[r].Quantity;n.invquantityunit=e.results[r].BaseUnit;n.invamount=e.results[r].InvoiceAmtInCoCodeCrcy;n.invcurrency=e.results[r].DocumentCurrency_01;var c=d._invRec.findIndex(function(e){return e.PurchaseOrder===n.PurchaseOrder&&e.PurchaseOrderItem===n.PurchaseOrderItem});if(c===-1){d._invRec.push(n)}else{d._invRec[c].invquantity=parseFloat(d._invRec[c].invquantity)+parseFloat(n.invquantity);d._invRec[c].invamount=parseFloat(d._invRec[c].invamount)+parseFloat(n.invamount)}}if(e.results[r].DebitCreditCode==="H"&&e.results[r].PurchasingHistoryCategory==="Q"&&e.results[r].PurchasingHistoryDocumentType==="2"){u.PurchaseOrder=e.results[r].PurchaseOrder;u.PurchaseOrderItem=e.results[r].PurchaseOrderItem;u.PurchasingHistoryDocument=e.results[r].PurchasingHistoryDocument;u.PurchasingHistoryDocumentItem=e.results[r].PurchasingHistoryDocumentItem;u.PurchasingHistoryDocumentYear=e.results[r].PurchasingHistoryDocumentYear;u.rinvquantity=e.results[r].Quantity;u.rinvamount=e.results[r].InvoiceAmtInCoCodeCrcy;u.rinvcurrency=e.results[r].DocumentCurrency_01;var h=d._rinvRec.findIndex(function(e){return e.PurchaseOrder===u.PurchaseOrder&&e.PurchaseOrderItem===u.PurchaseOrderItem});if(h===-1){u.rinvquantity=parseFloat(u.rinvquantity)*-1;u.rinvamount=parseFloat(u.rinvamount)*-1;d._rinvRec.push(u)}else{d._rinvRec[h].rinvquantity=parseFloat(d._rinvRec[h].rinvquantity)+parseFloat(u.rinvquantity)*-1;d._rinvRec[h].rinvamount=parseFloat(d._rinvRec[h].rinvamount)+parseFloat(u.rinvamount)*-1}}}t()}else{var p=d.getView().getModel("i18n").getResourceBundle().getText("ndmsg");sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.information(p)}},error:function(e){var t={};r()}})});C.then(function(){d._calculateOpenGR()})}},getData:function(e){this._getPOHistoryData()},_calculateOpenGR:function(){for(var e=0;e<this._poRec.length;e++){var t={};t.PurchaseOrder=this._poRec[e].PurchaseOrder;t.PurchaseOrderItem=this._poRec[e].PurchaseOrderItem;t.Supplier=this._poRec[e].Supplier;t.SupplierName=this._poRec[e].SupplierName;t.Material=this._poRec[e].Material;t.ProductName=this._poRec[e].ProductName;t.ddate=this._poRec[e].ddate;t.pdate=this._poRec[e].pdate;t.MaterialBaseUnit=this._poRec[e].MaterialBaseUnit;t.Plant=this._poRec[e].Plant;t.OrderQuantity=this._poRec[e].OrderQuantity;t.PurchaseOrderQuantityUnit=this._poRec[e].PurchaseOrderQuantityUnit;t.NetAmount=this._poRec[e].NetAmount;t.NetPriceAmount=this._poRec[e].NetPriceAmount;t.pocurrency=this._poRec[e].pocurrency;t.DocumentCurrency=this._poRec[e].DocumentCurrency;for(var r=0;r<this._grRec.length;r++){if(t.PurchaseOrder===this._grRec[r].PurchaseOrder&&t.PurchaseOrderItem===this._grRec[r].PurchaseOrderItem){t.grquantity=this._grRec[r].grquantity;t.grquantityunit=this._grRec[r].grquantityunit;t.gramount=this._grRec[r].GRAmount;t.grcurrency=this._grRec[r].grcurrency;t.grunitprice=t.NetPriceAmount;this._grcurrency=t.grcurrency}}for(var s=0;s<this._rgrRec.length;s++){if(t.PurchaseOrder===this._rgrRec[s].PurchaseOrder&&t.PurchaseOrderItem===this._rgrRec[s].PurchaseOrderItem){t.rgrquantity=this._rgrRec[s].rgrquantity;t.rgramount=this._rgrRec[s].rGRAmount}}for(var i=0;i<this._invRec.length;i++){if(t.PurchaseOrder===this._invRec[i].PurchaseOrder&&t.PurchaseOrderItem===this._invRec[i].PurchaseOrderItem){t.invquantity=this._invRec[i].invquantity;t.invquantityunit=this._invRec[i].invquantityunit;t.invamount=this._invRec[i].invamount;t.invcurrency=this._invRec[i].invcurrency;this._invcurrency=t.invcurrency;t.invunitprice=t.NetPriceAmount}}for(var a=0;a<this._rinvRec.length;a++){if(t.PurchaseOrder===this._rinvRec[a].PurchaseOrder&&t.PurchaseOrderItem===this._rinvRec[a].PurchaseOrderItem){t.rinvquantity=this._rinvRec[a].rinvquantity;t.rinvamount=this._rinvRec[a].rinvamount}}if(isNaN(t.rgrquantity)){t.rgrquantity=0}if(isNaN(t.rgramount)){t.rgramount=0}if(isNaN(t.invquantity)){t.invquantity=0}if(isNaN(t.invamount)){t.invamount=0}if(isNaN(t.rinvquantity)){t.rinvquantity=0}if(isNaN(t.rinvamount)){t.rinvamount=0}t.tgrquantity=parseFloat(t.grquantity)+parseFloat(t.rgrquantity);t.tinvquantity=parseFloat(t.invquantity)+parseFloat(t.rinvquantity);t.tgramount=parseFloat(t.gramount)+parseFloat(t.rgramount);t.tinvamount=parseFloat(t.invamount)+parseFloat(t.rinvamount);t.damount=parseFloat(t.tgramount)-parseFloat(t.tinvamount);t.qdiff=parseFloat(t.tgrquantity)-parseFloat(t.tinvquantity);t.tgramount=parseFloat(t.tgramount).toFixed(2);t.tinvamount=parseFloat(t.tinvamount).toFixed(2);t.damount=parseFloat(t.damount).toFixed(2);if(t.qdiff!==0){this._tgramount=parseFloat(this._tgramount)+parseFloat(t.tgramount);this._tinvamount=parseFloat(this._tinvamount)+parseFloat(t.tinvamount);this._tamtdiff=parseFloat(this._tamtdiff)+parseFloat(t.damount);this._poout.push(t)}this._poout.sort(function(e,t){var r=parseInt(e.PurchaseOrder);var s=parseInt(e.PurchaseOrderItem);var i=parseInt(t.PurchaseOrder);var a=parseInt(t.PurchaseOrderItem);if(r<i){return-1}if(r===i){if(s<a){return-1}}});this._tgramount=parseFloat(this._tgramount).toFixed(2);this._tinvamount=parseFloat(this._tinvamount).toFixed(2);this._tamtdiff=parseFloat(this._tamtdiff).toFixed(2);this._total="Total"}this._display()},_display:function(){sap.ui.core.BusyIndicator.hide();var e=this.byId("openGRTable");this._out.rec=this._poout;this._out.gramount=this._tgramount;this._out.grcurrency=this._grcurrency;this._out.invamount=this._tinvamount;this._out.invcurrency=this._invcurrency;this._out.amtdiff=this._tamtdiff;this._out.Total=this._total;this._oModel.setData(this._out);e.setModel(this._oModel);if(this._out.rec.length===0){var t=this.getView().getModel("i18n").getResourceBundle().getText("ngrm");sap.m.MessageBox.information(t)}},searchSuppliers:function(){if(!this._sValueObj){this._sValueObj=sap.ui.core.Fragment.load({name:"OpenGR.OpenGR.view.supplierHelp",controller:this})}else{this._flag="X"}var e=this;var t=new a({key:"US01",text:"US01"});var r=sap.ui.getCore().byId("compinput");var u=[];u.push(t);r.setTokens(u);this._sValueObj.then(function(t){e._helpDialog=t;var r=new sap.m.SearchField({sId:"sfield",showSearchButton:false});var a=sap.ui.getCore().byId("sfbar");a.setBasicSearch(r);t.open();t.getTableAsync().then(function(r){if(e._flag!=="X"){var a=new n({text:"{Supplier}"});var u=new sap.ui.table.Column({label:"Supplier",template:a,width:"8rem"});var o=new n({text:"{SupplierName}"});var l=new sap.ui.table.Column({label:"SupplierName",template:o,width:"8rem"});r.addColumn(u);r.addColumn(l)}r.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Auto);r.bindAggregation("rows",{path:"/rec"});var c=[];var h=new s("CompanyCode",i.EQ,"US01");c.push(h);e._sarr=[];r.setBusy(true);e._sModel.read("/A_SupplierCompany",{filters:c,urlParameters:{$expand:"to_Supplier"},success:function(t){for(var s=0;s<t.results.length;s++){var i={};i.Supplier=t.results[s].to_Supplier.Supplier;i.SupplierName=t.results[s].to_Supplier.SupplierName;e._sarr.push(i)}e._sObj.rec=e._sarr;e._nsModel=new sap.ui.model.json.JSONModel;e._nsModel.setData(e._sObj);r.setModel(e._nsModel);r.setBusy(false)},error:function(e){}});e._sTable=r;t.update()}).bind(e)})},searchCompanyCodes:function(){if(!this._companyXMlObj){this._companyXMlObj=new sap.ui.core.Fragment.load({name:"OpenGR.OpenGR.view.companyCodeHelp",controller:this})}else{this._cflag="X"}var e=this;this._companyXMlObj.then(function(t){t.setModel(e._coModel);e._chelpObj=t;t.open();t.getTableAsync().then(function(r){if(e._cflag!=="X"){var s=new n({text:"{CompanyCode}"});var i=new sap.ui.table.Column({label:"Company Code",template:s,width:"8rem"});var a=new n({text:"{CompanyCodeName}"});var u=new sap.ui.table.Column({label:"Company Code Name",template:a,width:"8rem"});r.addColumn(i);r.addColumn(u)}r.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Auto);r.setModel(e._coModel);r.bindAggregation("rows",{path:"/A_CompanyCode",parameters:{select:"CompanyCode,CompanyCodeName"}});t.update()}).bind(e)})},onSuppFilter:function(){var e=this;var t=[];var r=sap.ui.getCore().byId("compinput");var a=r.getTokens();this._sTable.setBusy(true);for(var n=0;n<a.length;n++){var u=a[n].getKey();var o=new s("CompanyCode",i.EQ,u);t.push(o)}this._sarr=[];this._sTable.setBusy(true);this._sModel.read("/A_SupplierCompany",{filters:t,urlParameters:{$expand:"to_Supplier"},success:function(t){for(var r=0;r<t.results.length;r++){var s={};s.Supplier=t.results[r].to_Supplier.Supplier;s.SupplierName=t.results[r].to_Supplier.SupplierName;e._sarr.push(s)}e._sObj.rec=e._sarr;e._nsModel=new sap.ui.model.json.JSONModel;e._nsModel.setData(e._sObj);e._sTable.setModel(e._nsModel);e._sTable.setBusy(false)},error:function(e){}})},onSuppSearch:function(e){sap.m.MessageBox.information("handler is called")},onValueHelpCancel:function(){this._helpDialog.close()},onValueHelpOk:function(e){var t=e.getParameter("tokens");var r=this.byId("supp");r.setTokens(t);this._helpDialog.close()},onValueHelpAfterClose:function(){this._helpDialog.destroy()},onCompanyHelpCancel:function(){this._chelpObj.close()},onCompanyHelpOk:function(e){var t=e.getParameter("tokens");var r=sap.ui.getCore().byId("compinput");r.setTokens(t);this._chelpObj.close()},onCompanyHelpAfterClose:function(){this._chelpObj.destroy()},downloadData:function(){if(this._poout.length>0){var e;var t=this._getColumnsData();var r={};this._xRec=this._poout;if(this._ddata!=="X"){r.tgramount=this._tgramount;r.tinvamount=this._tinvamount;r.damount=this._tamtdiff;r.Supplier="Total";this._xRec.push(r);this._ddata="X"}this._xOut.rec=this._xRec;this._xModel.setData(this._xOut);var s=this._xModel.getProperty("/rec");e={workbook:{columns:t},dataSource:s};var i=new o(e);i.build().then(function(){u.show("Spreadsheet export has finished")}).finally(i.destroy)}else{var a=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(a)}},_getColumnsData:function(){var e=[];var t=this.getView().getModel("i18n").getResourceBundle().getText("supplier");var r=this.getView().getModel("i18n").getResourceBundle().getText("sname");var s=this.getView().getModel("i18n").getResourceBundle().getText("plant");var i=this.getView().getModel("i18n").getResourceBundle().getText("po");var a=this.getView().getModel("i18n").getResourceBundle().getText("poitem");var n=this.getView().getModel("i18n").getResourceBundle().getText("material");var u=this.getView().getModel("i18n").getResourceBundle().getText("pdesc");var o=this.getView().getModel("i18n").getResourceBundle().getText("invp");var l=this.getView().getModel("i18n").getResourceBundle().getText("dater");var c=this.getView().getModel("i18n").getResourceBundle().getText("poq");var h=this.getView().getModel("i18n").getResourceBundle().getText("pup");var p=this.getView().getModel("i18n").getResourceBundle().getText("pamt");var d=this.getView().getModel("i18n").getResourceBundle().getText("poc");var g=this.getView().getModel("i18n").getResourceBundle().getText("qr");var m=this.getView().getModel("i18n").getResourceBundle().getText("grup");var y=this.getView().getModel("i18n").getResourceBundle().getText("ar");var v=this.getView().getModel("i18n").getResourceBundle().getText("grcurrency");var _=this.getView().getModel("i18n").getResourceBundle().getText("qi");var f=this.getView().getModel("i18n").getResourceBundle().getText("iup");var P=this.getView().getModel("i18n").getResourceBundle().getText("invcurrency");var R=this.getView().getModel("i18n").getResourceBundle().getText("ainv");var O=this.getView().getModel("i18n").getResourceBundle().getText("qd");var w=this.getView().getModel("i18n").getResourceBundle().getText("ad");e.push({label:t,property:"Supplier",width:10,type:"string"});e.push({label:r,property:"SupplierName",width:10,type:"string"});e.push({label:s,property:"Plant",width:10,type:"string"});e.push({label:i,property:"PurchaseOrder",width:10,type:"string"});e.push({label:a,property:"PurchaseOrderItem",width:10,type:"string"});e.push({label:n,property:"Material",width:10,type:"string"});e.push({label:u,property:"ProductName",width:10,type:"string"});e.push({label:o,property:"pdate",width:10,type:"string"});e.push({label:l,property:"ddate",width:10,type:"string"});e.push({label:c,property:"OrderQuantity",width:10,type:"string"});e.push({label:h,property:"NetPriceAmount",width:10,type:"string"});e.push({label:p,property:"NetAmount",width:10,type:"string"});e.push({label:d,property:"pocurrency",width:10,type:"string"});e.push({label:g,property:"tgrquantity",width:10,type:"string"});e.push({label:m,property:"grunitprice",width:10,type:"string"});e.push({label:y,property:"tgramount",width:10,type:"string"});e.push({label:v,property:"grcurrency",width:10,type:"string"});e.push({label:_,property:"tinvquantity",width:10,type:"string"});e.push({label:f,property:"invunitprice",width:10,type:"string"});e.push({label:R,property:"tinvamount",width:10,type:"string"});e.push({label:O,property:"qdiff",width:10,type:"string"});e.push({label:w,property:"damount",width:10,type:"string"});e.push({label:P,property:"invcurrency",width:10,type:"string"});return e}})});